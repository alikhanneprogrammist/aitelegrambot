import os
import pandas as pd
from openai import OpenAI
from dotenv import load_dotenv
from openpyxl import load_workbook
from typing import Optional, Dict, Any, List

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from utils import load_excel_with_cache, find_column, clean_numeric_data

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

class ChatGPTAnalyzer:
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ChatGPT AI –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞"""
        self.api_key = os.getenv("OPENAI_API_KEY")
        self.client = None
        
        if self.api_key:
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OpenAI —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ API –∫–ª—é—á –¥–æ—Å—Ç—É–ø–µ–Ω
            self.client = OpenAI(api_key=self.api_key)
    
    def analyze_sales_data(self, excel_file_path: str, focus: Optional[str] = None) -> str:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–∂ –∏–∑ Excel —Ñ–∞–π–ª–∞ —Å –ø–æ–º–æ—â—å—é ChatGPT AI
        
        Args:
            excel_file_path (str): –ü—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É
            focus (str, optional): –§–æ–∫—É—Å –∞–Ω–∞–ª–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "top_sales")
            
        Returns:
            str: –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        """
        if not self.client:
            return "‚ùå ChatGPT AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –∫–ª—é—á–∞ –≤ .env —Ñ–∞–π–ª–µ."
        
        try:
            # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—ç—à–∞
            sales_df = load_excel_with_cache(excel_file_path, '–ø—Ä–æ–¥–∞–∂–∏')
            salary_df = load_excel_with_cache(excel_file_path, '–∑–∞—Ä–ø–ª–∞—Ç–∞')
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            analysis_data = self._prepare_data_for_analysis(sales_df, salary_df)
            
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è ChatGPT
            prompt = self._create_analysis_prompt(analysis_data, focus)
            
            # –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏–∑ –æ—Ç ChatGPT
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –¥–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∏–Ω—Å–∞–π—Ç—ã."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=2000,
                temperature=0.7
            )
            
            return response.choices[0].message.content
            
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–∞–Ω–Ω—ã—Ö: {str(e)}"
    
    def _prepare_data_for_analysis(self, sales_df: pd.DataFrame, salary_df: pd.DataFrame) -> Dict[str, Any]:
        """–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"""
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É —Å —Ü–µ–Ω–∞–º–∏/—Å—É–º–º–∞–º–∏
        price_column = None
        possible_price_columns = ['price', '—Å—É–º–º–∞', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', 'total', 'amount']
        
        for col in possible_price_columns:
            if col in sales_df.columns:
                price_column = col
                break
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É —Å –æ—Å–Ω–æ–≤–Ω—ã–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º
        manager_column = None
        possible_manager_columns = ['manager', '–º–µ–Ω–µ–¥–∂–µ—Ä']
        
        for col in possible_manager_columns:
            if col in sales_df.columns:
                manager_column = col
                break
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É —Å ROP
        rop_column = None
        possible_rop_columns = ['employee ROP', 'rop', '–†–û–ü']
        
        for col in possible_rop_columns:
            if col in sales_df.columns:
                rop_column = col
                break
        
        # –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
        sales_stats = {
            'total_sales': pd.to_numeric(sales_df[price_column], errors='coerce').sum() if price_column else 0,
            'avg_sale': pd.to_numeric(sales_df[price_column], errors='coerce').mean() if price_column else 0,
            'total_transactions': len(sales_df),
            'unique_managers': sales_df[manager_column].nunique() if manager_column else 0,
            'unique_rop': sales_df[rop_column].nunique() if rop_column else 0,
            'price_column_used': price_column,
            'manager_column_used': manager_column,
            'rop_column_used': rop_column
        }
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
        if manager_column and price_column:
            try:
                # –£–±–∏—Ä–∞–µ–º NaN –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                valid_data = sales_df.dropna(subset=[manager_column])
                valid_data[price_column] = pd.to_numeric(valid_data[price_column], errors='coerce')
                manager_stats = valid_data.groupby(manager_column)[price_column].agg(['sum', 'count', 'mean']).round(2)
                sales_stats['manager_performance'] = manager_stats.to_dict('index')
            except Exception as e:
                sales_stats['manager_performance'] = {}
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ ROP —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º
        if rop_column and price_column:
            try:
                valid_data = sales_df.dropna(subset=[rop_column])
                valid_data[price_column] = pd.to_numeric(valid_data[price_column], errors='coerce')
                rop_stats = valid_data.groupby(rop_column)[price_column].agg(['sum', 'count', 'mean']).round(2)
                sales_stats['rop_performance'] = rop_stats.to_dict('index')
            except Exception as e:
                sales_stats['rop_performance'] = {}
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–∞–º (–µ—Å–ª–∏ –µ—Å—Ç—å –ª–∏—Å—Ç –∑–∞—Ä–ø–ª–∞—Ç–∞)
        salary_stats = {'note': '–î–∞–Ω–Ω—ã–µ –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–∞–º –Ω–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –¥–ª—è –ª–∏—Å—Ç–∞ –ø—Ä–æ–¥–∞–∂'}
        if salary_df is not None and not salary_df.empty:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –∑–∞—Ä–ø–ª–∞—Ç
            salary_column = None
            bonus_columns = []
            
            for col in salary_df.columns:
                if '–æ–∫–ª–∞–¥' in col.lower() or 'salary' in col.lower():
                    salary_column = col
                elif '–±–æ–Ω—É—Å' in col.lower() or 'bonus' in col.lower():
                    bonus_columns.append(col)
            
            if salary_column:
                salary_stats = {
                    'total_salary': pd.to_numeric(salary_df[salary_column], errors='coerce').sum(),
                    'avg_salary': pd.to_numeric(salary_df[salary_column], errors='coerce').mean(),
                    'total_bonuses': sum(pd.to_numeric(salary_df[col], errors='coerce').sum() for col in bonus_columns),
                    'salary_column_used': salary_column,
                    'bonus_columns_used': bonus_columns
                }
        
        return {
            'sales': sales_stats,
            'salary': salary_stats,
            'raw_sales_data': sales_df.head(10).to_dict('records'),  # –ü–µ—Ä–≤—ã–µ 10 –∑–∞–ø–∏—Å–µ–π
            'raw_salary_data': salary_df.head(10).to_dict('records') if salary_df is not None else []
        }
    
    def _create_analysis_prompt(self, data: Dict[str, Any], focus: Optional[str] = None) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö"""
        # –ë–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
        base_prompt = f"""
        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞—Ö –∫–æ–º–ø–∞–Ω–∏–∏:

        –û–°–ù–û–í–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–î–ê–ñ:
        - –û–±—â–∞—è —Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂: {data['sales']['total_sales']:,.0f} —Ç–µ–Ω–≥–µ
        - –°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏: {data['sales']['avg_sale']:,.0f} —Ç–µ–Ω–≥–µ
        - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {data['sales']['total_transactions']}
        - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {data['sales']['unique_managers']}
        - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ROP —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: {data['sales']['unique_rop']}

        –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –ó–ê–†–ü–õ–ê–¢–ê–ú:
        {self._format_salary_stats(data['salary'])}

        –ü–ï–†–í–´–ï 10 –ó–ê–ü–ò–°–ï–ô –ü–†–û–î–ê–ñ:
        {data['raw_sales_data']}

        –ü–ï–†–í–´–ï 10 –ó–ê–ü–ò–°–ï–ô –ó–ê–†–ü–õ–ê–¢:
        {data['raw_salary_data']}
        """
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ–∫—É—Å–∞
        if focus == "top_sales":
            prompt = base_prompt + """
            
            –°–§–û–ö–£–°–ò–†–£–ô–°–Ø –ù–ê –¢–û–ü –ü–†–û–î–ê–ñ–ê–•:
            - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ª—É—á—à–∏–µ –ø—Ä–æ–¥–∞–∂–∏ –∏ –∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
            - –í—ã–¥–µ–ª–∏ —Ç–æ–ø-–º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
            - –û–ø—Ä–µ–¥–µ–ª–∏ —Ñ–∞–∫—Ç–æ—Ä—ã —É—Å–ø–µ—Ö–∞ –≤ –ø—Ä–æ–¥–∞–∂–∞—Ö
            - –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–æ–¥–∞–∂

            –ü—Ä–æ–≤–µ–¥–∏ –ö–†–ê–¢–ö–ò–ô –∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å:
            1. –¢–æ–ø-3 –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º
            2. –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã —É—Å–ø–µ—Ö–∞
            3. –ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥ –∏ 1-2 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–æ–¥–∞–∂

            –í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π. –ú–∞–∫—Å–∏–º—É–º 5-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
            """
        else:
            prompt = base_prompt + """
            
            –ü—Ä–æ–≤–µ–¥–∏ –ö–†–ê–¢–ö–ò–ô –∞–Ω–∞–ª–∏–∑ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å:
            1. –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (2-3 –≥–ª–∞–≤–Ω—ã–µ —Ü–∏—Ñ—Ä—ã)
            2. –õ—É—á—à–∏–µ –∏ —Ö—É–¥—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            3. –ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥ –∏ 1-2 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

            –í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –±–µ–∑ –ª–∏—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π. –ú–∞–∫—Å–∏–º—É–º 5-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.
            """
        
        return prompt
    
    def _format_salary_stats(self, salary_data: Dict[str, Any]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–∞–º"""
        if isinstance(salary_data, dict) and 'note' in salary_data:
            return salary_data['note']
        
        if isinstance(salary_data, dict):
            result = ""
            if 'total_salary' in salary_data:
                result += f"- –û–±—â–∞—è —Å—É–º–º–∞ –æ–∫–ª–∞–¥–æ–≤: {salary_data['total_salary']:,.0f} —Ç–µ–Ω–≥–µ\n"
            if 'avg_salary' in salary_data:
                result += f"- –°—Ä–µ–¥–Ω–∏–π –æ–∫–ª–∞–¥: {salary_data['avg_salary']:,.0f} —Ç–µ–Ω–≥–µ\n"
            if 'total_bonuses' in salary_data:
                result += f"- –û–±—â–∞—è —Å—É–º–º–∞ –±–æ–Ω—É—Å–æ–≤: {salary_data['total_bonuses']:,.0f} —Ç–µ–Ω–≥–µ\n"
            
            if not result:
                return "- –î–∞–Ω–Ω—ã–µ –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–∞–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
            
            return result.strip()
        
        return "- –î–∞–Ω–Ω—ã–µ –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–∞–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
    
    def get_quick_insights(self, excel_file_path: str) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–µ –∏–Ω—Å–∞–π—Ç—ã –ø–æ –¥–∞–Ω–Ω—ã–º
        
        Args:
            excel_file_path (str): –ü—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É
            
        Returns:
            str: –ö—Ä–∞—Ç–∫–∏–µ –∏–Ω—Å–∞–π—Ç—ã
        """
        try:
            sales_df = load_excel_with_cache(excel_file_path, '–ø—Ä–æ–¥–∞–∂–∏')
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É —Å —Ü–µ–Ω–∞–º–∏/—Å—É–º–º–∞–º–∏
            price_column = None
            possible_price_columns = ['price', '—Å—É–º–º–∞', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', 'total', 'amount']
            
            for col in possible_price_columns:
                if col in sales_df.columns:
                    price_column = col
                    break
            
            if price_column is None:
                return f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —Å —Ü–µ–Ω–∞–º–∏. –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: {list(sales_df.columns)}"
            
            # –ë—ã—Å—Ç—Ä—ã–µ —Ä–∞—Å—á–µ—Ç—ã
            # –£–±–∏—Ä–∞–µ–º NaN –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
            price_data = pd.to_numeric(sales_df[price_column], errors='coerce').dropna()
            
            total_sales = price_data.sum()
            avg_sale = price_data.mean()
            max_sale = price_data.max()
            min_sale = price_data.min()
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º
            product_info = ""
            if 'name_boiler' in sales_df.columns:
                product_counts = sales_df['name_boiler'].value_counts().head(3)
                product_info = f"\n\nüèÜ –¢–û–ü-3 –¢–û–í–ê–†–ê:\n"
                for i, (product, count) in enumerate(product_counts.items(), 1):
                    product_info += f"‚Ä¢ {i}. {product}: {count} —à—Ç.\n"
            
            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
            manager_info = ""
            manager_columns = [col for col in sales_df.columns if 'manager' in col.lower()]
            if manager_columns:
                # –ë–µ—Ä–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–æ–ª–±–µ—Ü –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                main_manager_col = 'manager' if 'manager' in sales_df.columns else manager_columns[0]
                manager_counts = sales_df[main_manager_col].value_counts().head(3)
                manager_info = f"\n\nüë• –¢–û–ü-3 –ú–ï–ù–ï–î–ñ–ï–†–ê:\n"
                for i, (manager, count) in enumerate(manager_counts.items(), 1):
                    if pd.notna(manager) and str(manager) != 'nan':
                        manager_info += f"‚Ä¢ {i}. {manager}: {count} –∑–∞–∫–∞–∑–æ–≤\n"
            
            insights = f"""
üìä –ë–´–°–¢–†–´–ï –ò–ù–°–ê–ô–¢–´:
‚Ä¢ –û–±—â–∞—è —Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂: {total_sales:,.0f} —Ç–µ–Ω–≥–µ
‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏: {avg_sale:,.0f} —Ç–µ–Ω–≥–µ
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞: {max_sale:,.0f} —Ç–µ–Ω–≥–µ
‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞: {min_sale:,.0f} —Ç–µ–Ω–≥–µ
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {len(sales_df)}
‚Ä¢ –ö–æ–ª–æ–Ω–∫–∞ —Å —Ü–µ–Ω–∞–º–∏: {price_column}{product_info}{manager_info}
            """
            
            return insights.strip()
            
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Å–∞–π—Ç–æ–≤: {str(e)}"
    
    def generate_period_report(self, excel_file_path: str, period_request: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
        
        Args:
            excel_file_path (str): –ü—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É
            period_request (str): –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç—á–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–æ—Ç—á–µ—Ç –∑–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é")
            
        Returns:
            str: –û—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥
        """
        if not self.client:
            return "‚ùå ChatGPT AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –∫–ª—é—á–∞ –≤ .env —Ñ–∞–π–ª–µ."
        
        try:
            # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel
            sales_df = load_excel_with_cache(excel_file_path, '–ø—Ä–æ–¥–∞–∂–∏')
            
            # –°–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
            prompt = f"""
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª: "{period_request}"
            
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö –∏ —Å–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç.
            
            –î–ê–ù–ù–´–ï –û –ü–†–û–î–ê–ñ–ê–•:
            –ö–æ–ª–æ–Ω–∫–∏ –≤ –¥–∞–Ω–Ω—ã—Ö: {list(sales_df.columns)}
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {len(sales_df)}
            
            –ü–ï–†–í–´–ï 10 –ó–ê–ü–ò–°–ï–ô:
            {sales_df.head(10).to_dict('records')}
            
            –ü–û–°–õ–ï–î–ù–ò–ï 5 –ó–ê–ü–ò–°–ï–ô:
            {sales_df.tail(5).to_dict('records')}
            
            –°–¢–ê–¢–ò–°–¢–ò–ö–ê:
            - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(sales_df)}
            """
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ü–µ–Ω–∞–º, –µ—Å–ª–∏ –µ—Å—Ç—å
            price_column = find_column(sales_df, 'price')
            if price_column:
                price_data = clean_numeric_data(sales_df, price_column)
                prompt += f"""
            - –û–±—â–∞—è —Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂: {price_data.sum():,.0f} —Ç–µ–Ω–≥–µ
            - –°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞: {price_data.mean():,.0f} —Ç–µ–Ω–≥–µ
            - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞: {price_data.max():,.0f} —Ç–µ–Ω–≥–µ
            - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞: {price_data.min():,.0f} —Ç–µ–Ω–≥–µ
                """
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
            manager_column = find_column(sales_df, 'manager')
            if manager_column:
                manager_stats = sales_df[manager_column].value_counts().head(5)
                prompt += f"""
            
            –¢–û–ü-5 –ú–ï–ù–ï–î–ñ–ï–†–û–í –ü–û –ö–û–õ–ò–ß–ï–°–¢–í–£ –ó–ê–ö–ê–ó–û–í:
            {manager_stats.to_dict()}
                """
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–æ–≤–∞—Ä–∞–º
            product_column = find_column(sales_df, 'product')
            if product_column:
                product_stats = sales_df[product_column].value_counts().head(5)
                prompt += f"""
            
            –¢–û–ü-5 –¢–û–í–ê–†–û–í –ü–û –ö–û–õ–ò–ß–ï–°–¢–í–£ –ó–ê–ö–ê–ó–û–í:
            {product_stats.to_dict()}
                """
            
            prompt += f"""
            
            –ó–ê–î–ê–ß–ê:
            –°–æ–∑–¥–∞–π –ö–†–ê–¢–ö–ò–ô –æ—Ç—á–µ—Ç:
            1. –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–∏—Ñ—Ä—ã (–ø—Ä–æ–¥–∞–∂–∏, –∑–∞–∫–∞–∑—ã, —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫)
            2. –¢–û–ü-3 –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ —Ç–æ–≤–∞—Ä–∞
            3. –ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥
            
            –í–ê–ñ–ù–û: 
            - –ú–∞–∫—Å–∏–º—É–º 6-8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
            - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã, –º–∏–Ω–∏–º—É–º —Ç–µ–∫—Å—Ç–∞
            - –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥ - —Å–∫–∞–∂–∏ —Å—Ä–∞–∑—É
            """
            
            # –ü–æ–ª—É—á–∞–µ–º –∞–Ω–∞–ª–∏–∑ –æ—Ç ChatGPT
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –¥–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∏–Ω—Å–∞–π—Ç—ã."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=1500,
                temperature=0.7
            )
            
            return response.choices[0].message.content
            
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: {str(e)}"
    
    def universal_query(self, excel_file_path: str, user_query: str) -> str:
        """
        –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ - –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ –¥–∞–Ω–Ω—ã–º
        
        Args:
            excel_file_path (str): –ü—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É
            user_query (str): –õ—é–±–æ–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            str: –û—Ç–≤–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –∫–æ–º–∞–Ω–¥–æ–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if self._is_edit_command(user_query):
            return self.edit_excel_data(excel_file_path, user_query)
        
        # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        if not self.client:
            return "‚ùå ChatGPT AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –∫–ª—é—á–∞ –≤ .env —Ñ–∞–π–ª–µ."
        
        try:
            # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel
            sales_df = load_excel_with_cache(excel_file_path, '–ø—Ä–æ–¥–∞–∂–∏')
            
            # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            prompt = f"""
            –¢—ã - —É–º–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å –æ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂.
            
            –ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "{user_query}"
            
            –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê:
            - –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ "—Å—Ä–µ–¥–Ω–∏–π —á–µ–∫" - –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–ª–æ–Ω–∫—É 'price' –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞
            - –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ "–ø—Ä–∏–±—ã–ª—å" - –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–ª–æ–Ω–∫—É 'purchase' 
            - –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–∞—Ç—ã, –∞ –∫–æ–ª–æ–Ω–∫–∏ 'date' –Ω–µ—Ç - —Å–∫–∞–∂–∏ —Å—Ä–∞–∑—É "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–∞–º"
            
            –î–ê–ù–ù–´–ï –û –ü–†–û–î–ê–ñ–ê–•:
            –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (–∫–æ–ª–æ–Ω–∫–∏): {list(sales_df.columns)}
            –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {len(sales_df)}
            
            –û–ë–†–ê–ó–ï–¶ –î–ê–ù–ù–´–• (–ø–µ—Ä–≤—ã–µ 5 –∑–∞–ø–∏—Å–µ–π):
            {sales_df.head(5).to_dict('records')}
            
            –ü–û–°–õ–ï–î–ù–ò–ï 3 –ó–ê–ü–ò–°–ò:
            {sales_df.tail(3).to_dict('records')}
            
            –°–¢–ê–¢–ò–°–¢–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:
            """
            
            # –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –≤—Å–µ—Ö —á–∏—Å–ª–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
            numeric_columns = sales_df.select_dtypes(include=['number']).columns
            for col in numeric_columns:
                if not sales_df[col].isna().all():
                    prompt += f"""
            {col}:
              - –ú–∏–Ω–∏–º—É–º: {sales_df[col].min()}
              - –ú–∞–∫—Å–∏–º—É–º: {sales_df[col].max()}
              - –°—Ä–µ–¥–Ω–µ–µ: {sales_df[col].mean():.2f}
              - –°—É–º–º–∞: {sales_df[col].sum()}
                    """
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–º –∫–æ–ª–æ–Ω–∫–∞–º
            categorical_columns = sales_df.select_dtypes(include=['object', 'string']).columns
            for col in categorical_columns[:5]:  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 5 –∫–æ–ª–æ–Ω–æ–∫
                if not sales_df[col].isna().all():
                    unique_count = sales_df[col].nunique()
                    if unique_count <= 20:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –Ω–µ –º–Ω–æ–≥–æ
                        value_counts = sales_df[col].value_counts().head(5)
                        prompt += f"""
            {col} (—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π: {unique_count}):
              –¢–æ–ø-5 –∑–Ω–∞—á–µ–Ω–∏–π: {value_counts.to_dict()}
                        """
                    else:
                        prompt += f"""
            {col}: {unique_count} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                        """
            
            prompt += f"""
            
            –¢–í–û–Ø –ó–ê–î–ê–ß–ê:
            1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–π–º–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –æ–Ω —Ö–æ—á–µ—Ç —É–∑–Ω–∞—Ç—å
            2. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
            3. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è - —Å–¥–µ–ª–∞–π –∏—Ö
            4. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ - –Ω–∞–π–¥–∏ –∏—Ö
            5. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å –∏–ª–∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–Ω–¥—ã - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π
            6. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ - —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º —á–µ—Å—Ç–Ω–æ
            
            –¢–ò–ü–´ –ó–ê–ü–†–û–°–û–í, –ö–û–¢–û–†–´–ï –¢–´ –ú–û–ñ–ï–®–¨ –û–ë–†–ê–ë–û–¢–ê–¢–¨:
            - "–°–∫–æ–ª—å–∫–æ –∑–∞–∫–∞–∑–æ–≤ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ò–≤–∞–Ω?"
            - "–ö–∞–∫–æ–π —Ç–æ–≤–∞—Ä —Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π?"
            - "–°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ"
            - "–ü–æ–∫–∞–∂–∏ –≤—Å–µ –∑–∞–∫–∞–∑—ã –±–æ–ª—å—à–µ 100000 —Ç–µ–Ω–≥–µ"
            - "–°—Ä–∞–≤–Ω–∏ –ø—Ä–æ–¥–∞–∂–∏ —Ä–∞–∑–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"
            - "–ö–∞–∫–∏–µ —Ç–æ–≤–∞—Ä—ã –ø—Ä–æ–¥–∞—é—Ç—Å—è —Ö—É–∂–µ –≤—Å–µ–≥–æ?"
            - "–ù–∞–π–¥–∏ –∑–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–∞ XYZ"
            - "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏"
            - "–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂"
            - –ò –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã!
            
            –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
            - –ö–†–ê–¢–ö–û –∏ –ø–æ –¥–µ–ª—É - –º–∞–∫—Å–∏–º—É–º 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
            - –°—Ä–∞–∑—É –¥–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã
            - –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - —Å—Ä–∞–∑—É —Å–∫–∞–∂–∏ —á—Ç–æ –Ω—É–∂–Ω–æ
            - –ù–∏–∫–∞–∫–∏—Ö –¥–ª–∏–Ω–Ω—ã—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏ "–≤–æ–¥—ã"
            - –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
            - –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ - –≤—ã–±–µ—Ä–∏ —Å–∞–º—ã–π –ª–æ–≥–∏—á–Ω—ã–π
            
            –í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–æ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω—É–∂–µ–Ω –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç, –∞ –Ω–µ –ª–µ–∫—Ü–∏—è.
            """
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç ChatGPT
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –¥–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∏–Ω—Å–∞–π—Ç—ã."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=2000,
                temperature=0.7
            )
            
            return response.choices[0].message.content
            
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}"
    
    def _is_edit_command(self, user_query: str) -> bool:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å –∫–æ–º–∞–Ω–¥–æ–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        
        Args:
            user_query (str): –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            bool: True –µ—Å–ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        """
        edit_keywords = [
            '–∏–∑–º–µ–Ω–∏—Ç—å', '–∏–∑–º–µ–Ω–µ–Ω–∏–µ', '–ø–æ–º–µ–Ω—è—Ç—å', '–∏—Å–ø—Ä–∞–≤–∏—Ç—å', '–æ–±–Ω–æ–≤–∏—Ç—å',
            '–∑–∞–∫–∞–∑', '–∑–∞–∫–∞–∑–µ', '–∫–æ—Ç–µ–ª', '–∫–æ—Ç–ª—ã', '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', '—Ü–µ–Ω–∞', '—Ü–µ–Ω—É',
            '–≤–º–µ—Å—Ç–æ', '–≤–∑—è–ª', '–∑–∞–∫–∞–∑–∞–ª', '–Ω—É–∂–Ω–æ', '–Ω–∞–¥–æ', '–º–µ–Ω–µ–¥–∂–µ—Ä', '–º–µ–Ω–µ–¥–∂–µ—Ä–∞',
            '–ø–æ—Å—Ç–∞–≤—å', '–Ω–∞–∑–Ω–∞—á—å', '—É—Å—Ç–∞–Ω–æ–≤–∏', '—Å–º–µ–Ω–∏'
        ]
        
        query_lower = user_query.lower()
        return any(keyword in query_lower for keyword in edit_keywords)
    
    def execute_command(self, excel_file_path: str, command: str) -> str:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ª—é–±—É—é –∫–æ–º–∞–Ω–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            excel_file_path (str): –ü—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É
            command (str): –ö–æ–º–∞–Ω–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            str: –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
        """
        if not self.client:
            return "‚ùå ChatGPT AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –∫–ª—é—á–∞ –≤ .env —Ñ–∞–π–ª–µ."
        
        try:
            # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel
            sales_df = load_excel_with_cache(excel_file_path, '–ø—Ä–æ–¥–∞–∂–∏')
            
            # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
            prompt = f"""
            –¢—ã - —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–¥–∞–∂. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–ª –∫–æ–º–∞–Ω–¥—É: "{command}"
            
            –î–û–°–¢–£–ü–ù–´–ï –î–ê–ù–ù–´–ï:
            –ö–æ–ª–æ–Ω–∫–∏: {list(sales_df.columns)}
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π: {len(sales_df)}
            
            –ü–ï–†–í–´–ï 5 –ó–ê–ü–ò–°–ï–ô:
            {sales_df.head(5).to_dict('records')}
            
            –¢–ò–ü–´ –ö–û–ú–ê–ù–î, –ö–û–¢–û–†–´–ï –¢–´ –ú–û–ñ–ï–®–¨ –í–´–ü–û–õ–ù–ò–¢–¨:
            
            1. –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –î–ê–ù–ù–´–•:
            - "–∏–∑–º–µ–Ω–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ –∑–∞–∫–∞–∑–µ 1 –Ω–∞ –ê–ª–∏–±–µ–∫"
            - "–ø–æ–º–µ–Ω—è—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∑–∞–∫–∞–∑–µ 2 –Ω–∞ 3"
            - "–æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É –≤ –∑–∞–∫–∞–∑–µ 3 –Ω–∞ 50000"
            - "–Ω–∞–∑–Ω–∞—á–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ê–π–¥–∞–Ω–∞ –≤ –∑–∞–∫–∞–∑–µ 4"
            
            2. –ü–û–ò–°–ö –ò –§–ò–õ–¨–¢–†–ê–¶–ò–Ø:
            - "–Ω–∞–π–¥–∏ –≤—Å–µ –∑–∞–∫–∞–∑—ã –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ê–ª–∏–±–µ–∫"
            - "–ø–æ–∫–∞–∂–∏ –∑–∞–∫–∞–∑—ã –±–æ–ª—å—à–µ 100000 —Ç–µ–Ω–≥–µ"
            - "–Ω–∞–π–¥–∏ –∑–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–∞ –ò–≤–∞–Ω"
            - "–ø–æ–∫–∞–∂–∏ –≤—Å–µ –∑–∞–∫–∞–∑—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è"
            
            3. –ê–ù–ê–õ–ò–ó –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê:
            - "—Å–∫–æ–ª—å–∫–æ –∑–∞–∫–∞–∑–æ–≤ —É –∫–∞–∂–¥–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞"
            - "–∫–∞–∫–∞—è —Å—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞"
            - "–∫–∞–∫–æ–π —Ç–æ–≤–∞—Ä —Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π"
            - "–ø–æ–∫–∞–∂–∏ —Ç–æ–ø-5 –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"
            
            4. –û–¢–ß–ï–¢–´:
            - "—Å–æ–∑–¥–∞–π –æ—Ç—á–µ—Ç –∑–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é"
            - "–ø–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–µ—Å—è—Ü–∞–º"
            - "—Å—Ä–∞–≤–Ω–∏ –ø—Ä–æ–¥–∞–∂–∏ —Ä–∞–∑–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"
            
            –ü–†–ê–í–ò–õ–ê –í–´–ü–û–õ–ù–ï–ù–ò–Ø:
            - –ï—Å–ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –¥–∞–π —Ç–æ—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ EDIT_INSTRUCTIONS
            - –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–∏—Å–∫ - –Ω–∞–π–¥–∏ –∏ –ø–æ–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏
            - –ï—Å–ª–∏ —ç—Ç–æ –∞–Ω–∞–ª–∏–∑ - –ø—Ä–æ–≤–µ–¥–∏ —Ä–∞—Å—á–µ—Ç—ã –∏ –¥–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            - –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç—á–µ—Ç - —Å–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç
            
            –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
            - –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: EDIT_INSTRUCTIONS: [–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏]
            - –î–ª—è –ø–æ–∏—Å–∫–∞: –ù–ê–ô–î–ï–ù–û: [—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã]
            - –î–ª—è –∞–Ω–∞–ª–∏–∑–∞: –ê–ù–ê–õ–ò–ó: [—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã]
            - –î–ª—è –æ—Ç—á–µ—Ç–æ–≤: –û–¢–ß–ï–¢: [–æ—Ç—á–µ—Ç]
            
            –í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ—è—Å–Ω–∞ - —É—Ç–æ—á–Ω–∏ —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å.
            """
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç Gemini
            response = self.model.generate_content(prompt)
            result = response.text
            
            # –ï—Å–ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if "EDIT_INSTRUCTIONS:" in result:
                return self._apply_edit_instructions(excel_file_path, sales_df, result)
            
            return result
            
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã: {str(e)}"
    
    def edit_excel_data(self, excel_file_path: str, edit_request: str) -> str:
        """
        –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ Excel —Ñ–∞–π–ª–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            excel_file_path (str): –ü—É—Ç—å –∫ Excel —Ñ–∞–π–ª—É
            edit_request (str): –¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–∑–∞–∫–∞–∑ –Ω–æ–º–µ—Ä #2 –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö –∫–æ—Ç–ª–æ–≤ –≤–∑—è–ª –æ–¥–∏–Ω")
            
        Returns:
            str: –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
        """
        print(f"üîç CHATGPT DEBUG: edit_excel_data –≤—ã–∑–≤–∞–Ω")
        print(f"üîç CHATGPT DEBUG: excel_file_path = {excel_file_path}")
        print(f"üîç CHATGPT DEBUG: edit_request = '{edit_request}'")
        print(f"üîç CHATGPT DEBUG: self.client = {self.client}")
        
        if not self.client:
            print(f"üîç CHATGPT DEBUG: –ö–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return "‚ùå ChatGPT AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –∫–ª—é—á–∞ –≤ .env —Ñ–∞–π–ª–µ."
        
        try:
            print(f"üîç CHATGPT DEBUG: –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª...")
            # –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—ç—à–∞
            sales_df = load_excel_with_cache(excel_file_path, '–ø—Ä–æ–¥–∞–∂–∏')
            print(f"üîç CHATGPT DEBUG: –ü—Ä–æ—á–∏—Ç–∞–Ω–æ {len(sales_df)} —Å—Ç—Ä–æ–∫")
            print(f"üîç CHATGPT DEBUG: –ö–æ–ª–æ–Ω–∫–∏: {sales_df.columns.tolist()}")
            
            print(f"üîç CHATGPT DEBUG: –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç...")
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            prompt = self._create_edit_prompt(sales_df, edit_request)
            print(f"üîç CHATGPT DEBUG: –ü—Ä–æ–º–ø—Ç —Å–æ–∑–¥–∞–Ω, –¥–ª–∏–Ω–∞: {len(prompt)}")
            
            print(f"üîç CHATGPT DEBUG: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ ChatGPT...")
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Ç ChatGPT
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –¥–∞–≤–∞–π —Ç–æ—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=1500,
                temperature=0.3
            )
            edit_instructions = response.choices[0].message.content
            print(f"üîç CHATGPT DEBUG: –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç ChatGPT: {edit_instructions[:200]}...")
            
            print(f"üîç CHATGPT DEBUG: –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏...")
            # –ü–∞—Ä—Å–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            result = self._apply_edit_instructions(excel_file_path, sales_df, edit_instructions)
            print(f"üîç CHATGPT DEBUG: –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: {result[:100]}...")
            
            return result
            
        except Exception as e:
            print(f"üîç CHATGPT DEBUG: –û—à–∏–±–∫–∞ –≤ edit_excel_data: {str(e)}")
            import traceback
            print(f"üîç CHATGPT DEBUG: –ü–æ–ª–Ω—ã–π traceback:")
            traceback.print_exc()
            return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {str(e)}"
    
    def _create_edit_prompt(self, sales_df: pd.DataFrame, edit_request: str) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π"""
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        sample_data = sales_df.head(5).to_dict('records')
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        columns_info = list(sales_df.columns)
        
        prompt = f"""
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö. –í–æ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ:

        –ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "{edit_request}"

        –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–• (–∫–æ–ª–æ–Ω–∫–∏):
        {columns_info}

        –¢–ï–ö–£–©–ò–ï –î–ê–ù–ù–´–ï (–ø–µ—Ä–≤—ã–µ 5 –∑–∞–ø–∏—Å–µ–π):
        {sample_data}

        –í–ê–ñ–ù–û! –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ:
        - –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: 'order' 
        - –î–∞—Ç–∞: 'date'
        - –ö–ª–∏–µ–Ω—Ç: 'client'
        - –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ—Ç–ª–∞/—Ç–æ–≤–∞—Ä–∞: 'name_boiler'
        - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 'quantity'
        - –¶–µ–Ω–∞: 'price'
        - –ü–æ–∫—É–ø–∫–∞: 'purchase'
        - –û–ø–ª–∞—Ç–∞: 'payment'
        - –î–æ—Å—Ç–∞–≤–∫–∞: 'delivery'
        - –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã: 'accessories'
        - –û—Å–Ω–æ–≤–Ω–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä: 'manager'
        - –î—Ä—É–≥–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –º–æ–≥—É—Ç –±—ã—Ç—å –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö: manager_1, manager_2, manager_3, manager_4, manager_5, manager_6, manager_7
        - ROP —Å–æ—Ç—Ä—É–¥–Ω–∏–∫: 'employee ROP'
        - –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: 'developer'
        - –ü–æ–º–æ—â–Ω–∏–∫–∏: 'assistant', 'assistant 2'
        - –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: 'supplier manager'

        –ü–†–ê–í–ò–õ–ê –ü–û–ò–°–ö–ê –ò –°–û–ó–î–ê–ù–ò–Ø:
        - –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è "–∑–∞–∫–∞–∑ –Ω–æ–º–µ—Ä #X" –∏–ª–∏ "–∑–∞–∫–∞–∑–µ X", –∏—â–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–µ 'order'
        - –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è —Ç–æ–≤–∞—Ä "–∫–æ—Ç–ª—ã", "–∫–æ—Ç–µ–ª", –∏—â–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–µ 'name_boiler'
        - –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞, –∏—â–∏ –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ (manager, manager_1, manager_2, –∏ —Ç.–¥.)
        - –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Ä–∞–±–æ—Ç–∞–π —Å –∫–æ–ª–æ–Ω–∫–æ–π 'quantity'
        - –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è —Ü–µ–Ω–∞, —Ä–∞–±–æ—Ç–∞–π —Å –∫–æ–ª–æ–Ω–∫–æ–π 'price'
        
        –ö–û–ú–ê–ù–î–´ –°–û–ó–î–ê–ù–ò–Ø –ù–û–í–´–• –ó–ê–ö–ê–ó–û–í:
        - –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç "–°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑" –∏–ª–∏ "—Å–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑", —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        - –ò–∑–≤–ª–µ–∫–∞–π –¥–∞–Ω–Ω—ã–µ: –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞, –¥–∞—Ç—É, —Ç–æ–≤–∞—Ä, –º–µ–Ω–µ–¥–∂–µ—Ä–∞, –¥–æ—Å—Ç–∞–≤–∫—É
        - –î–ª—è –¥–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2025-09-12)

        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Ç–æ—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:

        –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –ó–ê–ü–ò–°–ï–ô:
        EDIT_INSTRUCTIONS:
        - –ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å: [—É—Å–ª–æ–≤–∏–µ –ø–æ–∏—Å–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä: order == 2]
        - –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–µ: [–Ω–∞–∑–≤–∞–Ω–∏–µ_–ø–æ–ª—è] = [–Ω–æ–≤–æ–µ_–∑–Ω–∞—á–µ–Ω–∏–µ]
        - –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å: [–Ω–∞–∑–≤–∞–Ω–∏–µ_–ø–æ–ª—è] = [—Ñ–æ—Ä–º—É–ª–∞_–ø–µ—Ä–µ—Å—á–µ—Ç–∞]

        –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ù–û–í–´–• –ó–ê–ö–ê–ó–û–í:
        EDIT_INSTRUCTIONS:
        - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑: [–Ω–æ–º–µ—Ä_–∑–∞–∫–∞–∑–∞]
        - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ: [–Ω–∞–∑–≤–∞–Ω–∏–µ_–ø–æ–ª—è] = [–∑–Ω–∞—á–µ–Ω–∏–µ]
        - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ: [–Ω–∞–∑–≤–∞–Ω–∏–µ_–ø–æ–ª—è] = [–∑–Ω–∞—á–µ–Ω–∏–µ]
        - ... (–¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π)

        –ü–†–ò–ú–ï–†–´:
        - –î–ª—è "–∑–∞–∫–∞–∑ –Ω–æ–º–µ—Ä #2": order == 2
        - –î–ª—è "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ç–ª–æ–≤": quantity
        - –î–ª—è "–º–µ–Ω–µ–¥–∂–µ—Ä –ò–≤–∞–Ω": –Ω–∞–π—Ç–∏ –≤ manager –∏–ª–∏ manager_1, manager_2, –∏ —Ç.–¥.
        - –î–ª—è "–°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ –Ω–æ–º–µ—Ä 19": —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å order = 19

        –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.
        """
        return prompt
    
    def _apply_edit_instructions(self, excel_file_path: str, sales_df: pd.DataFrame, edit_instructions: str) -> str:
        """–ü—Ä–∏–º–µ–Ω—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫ Excel —Ñ–∞–π–ª—É"""
        try:
            # –ü–∞—Ä—Å–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            instructions = self._parse_edit_instructions(edit_instructions)
            
            print(f"üîç DEBUG: –ù–∞–π–¥–µ–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π: {len(instructions)}")
            
            if not instructions:
                return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–Ω—è—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è"
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫ DataFrame
            modified_df = sales_df.copy()
            results = []
            
            for instruction in instructions:
                if instruction['action'] == 'create_new_order':
                    print("üîç DEBUG: –í—Ö–æ–¥–∏–º –≤ –±–ª–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞")
                    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
                    new_order_data = instruction['data']
                    order_num = new_order_data.get('order')
                    print(f"üîç DEBUG: order_num = {order_num}")
                    
                    # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ 'auto', –Ω–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–æ–º–µ—Ä
                    if order_num == 'auto':
                        if 'order' in modified_df.columns:
                            max_order = modified_df['order'].max() if not modified_df.empty else 0
                            order_num = int(max_order) + 1
                        else:
                            order_num = 1
                    
                    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
                    new_row = {}
                    for field, value in new_order_data.items():
                        if field != 'order':
                            new_row[field] = value
                    
                    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
                    new_row['order'] = order_num
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ DataFrame
                    new_row_df = pd.DataFrame([new_row])
                    modified_df = pd.concat([modified_df, new_row_df], ignore_index=True)
                    
                    print(f"‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ #{order_num}")
                    
                elif instruction['action'] == 'find_and_edit':
                    # –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –ø–æ —É—Å–ª–æ–≤–∏—é
                    condition = instruction['condition']
                    field = instruction['field']
                    new_value = instruction['new_value']
                    
                    # –ü–∞—Ä—Å–∏–º —É—Å–ª–æ–≤–∏–µ –ø–æ–∏—Å–∫–∞
                    if isinstance(condition, str):
                        # –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏–µ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏, –ø–∞—Ä—Å–∏–º –µ–≥–æ
                        if 'order ==' in condition:
                            # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
                            order_num = int(condition.split('order ==')[1].strip())
                            mask = modified_df['order'] == order_num
                        else:
                            # –î—Ä—É–≥–∏–µ —É—Å–ª–æ–≤–∏—è –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
                            print(f"‚ö†Ô∏è –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–µ —É—Å–ª–æ–≤–∏–µ: {condition}")
                            continue
                    else:
                        # –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏–µ —É–∂–µ –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä—è
                        mask = self._apply_condition(modified_df, condition)
                    
                    if mask.any():
                        # –ò–∑–º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                        modified_df.loc[mask, field] = new_value
                        
                        # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                        if field in ['quantity', '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–∫–æ–ª-–≤–æ']:
                            # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞
                            if 'price' in modified_df.columns:
                                # –ï—Å–ª–∏ –µ—Å—Ç—å –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
                                original_qty = sales_df.loc[mask, field].iloc[0] if len(sales_df.loc[mask, field]) > 0 else 1
                                if original_qty > 0:
                                    price_per_unit = sales_df.loc[mask, 'price'].iloc[0] / original_qty if 'price' in sales_df.columns else 0
                                    modified_df.loc[mask, 'price'] = new_value * price_per_unit
                        
                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Excel
                        self._save_excel_changes(excel_file_path, modified_df)
                        
                        return f"‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –≤–Ω–µ—Å–µ–Ω—ã!\n\n–ù–∞–π–¥–µ–Ω–∞ –∑–∞–ø–∏—Å—å: {condition}\n–ò–∑–º–µ–Ω–µ–Ω–æ –ø–æ–ª–µ '{field}' –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ: {new_value}"
                    else:
                        return f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∑–∞–ø–∏—Å—å –ø–æ —É—Å–ª–æ–≤–∏—é: {condition}"
                
                elif instruction['action'] == 'create_new_order':
                    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
                    new_order_data = instruction['data']
                    order_num = new_order_data.get('order')
                    
                    # –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ 'auto', –Ω–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–æ–º–µ—Ä
                    if order_num == 'auto':
                        if 'order' in modified_df.columns:
                            max_order = modified_df['order'].max() if not modified_df.empty else 0
                            order_num = int(max_order) + 1
                        else:
                            order_num = 1
                    
                    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
                    new_row = {}
                    for field, value in new_order_data.items():
                        if field != 'order':
                            new_row[field] = value
                    
                    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
                    new_row['order'] = order_num
                    print(f"üîç DEBUG: new_row —Å–æ–∑–¥–∞–Ω: {new_row}")
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ DataFrame
                    try:
                        new_row_df = pd.DataFrame([new_row])
                        modified_df = pd.concat([modified_df, new_row_df], ignore_index=True)
                        print(f"üîç DEBUG: –°—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ DataFrame")
                    except Exception as e:
                        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏: {e}")
                        # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º continue, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                    
                    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–∫–∞–∑–µ
                    product = new_order_data.get('product', '–Ω–µ —É–∫–∞–∑–∞–Ω')
                    manager = new_order_data.get('manager', '–Ω–µ —É–∫–∞–∑–∞–Ω')
                    delivery = new_order_data.get('delivery', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')
                    quantity = new_order_data.get('quantity', 1)
                    
                    print(f"üîç DEBUG: –î–æ—Ö–æ–¥–∏–º –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–µ")
                    
                    result_msg = f"‚úÖ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #{order_num} —Å–æ–∑–¥–∞–Ω! –¢–æ–≤–∞—Ä: {product}, –ú–µ–Ω–µ–¥–∂–µ—Ä: {manager}, –î–æ—Å—Ç–∞–≤–∫–∞: {delivery}"
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Å–ø–∏—Å–æ–∫
                    results.append(result_msg)
                    print(f"‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ #{order_num}")
                    print(f"üîç DEBUG: –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫, –≤—Å–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {len(results)}")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –¥–æ—à–ª–∏ –¥–æ —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞
                    print(f"üîç DEBUG: –î–æ—Ö–æ–¥–∏–º –¥–æ –∫–æ–Ω—Ü–∞ –±–ª–æ–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Excel –æ–¥–∏–Ω —Ä–∞–∑ –≤ –∫–æ–Ω—Ü–µ
            if not modified_df.equals(sales_df):
                self._save_excel_changes(excel_file_path, modified_df)
                print("‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Excel —Ñ–∞–π–ª")
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if results:
                return "\n".join(results)
            else:
                return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
            
        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π: {str(e)}"
    
    def _parse_edit_instructions(self, instructions_text: str) -> List[Dict[str, Any]]:
        """–ü–∞—Ä—Å–∏—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
        instructions = []
        
        # –ò—â–µ–º –±–ª–æ–∫ EDIT_INSTRUCTIONS
        if "EDIT_INSTRUCTIONS:" in instructions_text:
            instructions_section = instructions_text.split("EDIT_INSTRUCTIONS:")[1]
        else:
            instructions_section = instructions_text
        
        lines = instructions_section.strip().split('\n')
        
        current_condition = None
        
        current_order_data = {}
        is_creating_new_order = False
        
        for line in lines:
            line = line.strip()
            if line.startswith('- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑:') or line.startswith('–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑:'):
                order_num = line.replace('- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑:', '').replace('–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑:', '').strip()
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ç–∏–ø–∞ "[–Ω–æ–º–µ—Ä_–∑–∞–∫–∞–∑–∞] = 6"
                if '=' in order_num:
                    order_num = order_num.split('=')[1].strip()
                # –£–±–∏—Ä–∞–µ–º —Å–∫–æ–±–∫–∏ –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ
                order_num = order_num.replace('[', '').replace(']', '').strip()
                if order_num.isdigit():
                    current_order_data['order'] = int(order_num)
                else:
                    # –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –∏–∑–≤–ª–µ—á—å —á–∏—Å–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–æ–º–µ—Ä
                    current_order_data['order'] = 'auto'
                is_creating_new_order = True
            elif line.startswith('- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ:') or line.startswith('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ:'):
                field_part = line.replace('- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ:', '').replace('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ:', '').strip()
                if '=' in field_part:
                    field, new_value = field_part.split('=', 1)
                    field = field.strip()
                    new_value = new_value.strip()
                    
                    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø
                    if new_value.isdigit():
                        new_value = int(new_value)
                    elif new_value.replace('.', '').isdigit():
                        new_value = float(new_value)
                    elif new_value.startswith('"') and new_value.endswith('"'):
                        new_value = new_value[1:-1]
                    elif new_value.startswith("'") and new_value.endswith("'"):
                        new_value = new_value[1:-1]
                    
                    if is_creating_new_order:
                        current_order_data[field] = new_value
                    else:
                        instructions.append({
                            'action': 'find_and_edit',
                            'condition': current_condition or '',
                            'field': field,
                            'new_value': new_value
                        })
            elif line.startswith('- –ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å:') or line.startswith('–ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å:'):
                condition = line.replace('- –ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å:', '').replace('–ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å—å:', '').strip()
                current_condition = condition
                is_creating_new_order = False
            elif line.startswith('- –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–µ:') or line.startswith('–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–µ:'):
                field_part = line.replace('- –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–µ:', '').replace('–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–µ:', '').strip()
                if '=' in field_part:
                    field, new_value = field_part.split('=', 1)
                    field = field.strip()
                    new_value = new_value.strip()
                    
                    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø
                    if new_value.isdigit():
                        new_value = int(new_value)
                    elif new_value.replace('.', '').isdigit():
                        new_value = float(new_value)
                    elif new_value.startswith('"') and new_value.endswith('"'):
                        new_value = new_value[1:-1]
                    elif new_value.startswith("'") and new_value.endswith("'"):
                        new_value = new_value[1:-1]
                    
                    instructions.append({
                        'action': 'find_and_edit',
                        'condition': current_condition or '',
                        'field': field,
                        'new_value': new_value
                    })
        
        # –ï—Å–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑, –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        if is_creating_new_order and current_order_data:
            instructions.append({
                'action': 'create_new_order',
                'data': current_order_data
            })
        
        # –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é
        if not instructions or not any(inst.get('action') == 'create_new_order' for inst in instructions):
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
            if ('–°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑' in instructions_text or '—Å–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑' in instructions_text or 
                '–î–æ–±–∞–≤—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑' in instructions_text or '–¥–æ–±–∞–≤—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑' in instructions_text):
                # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
                import re
                from datetime import datetime
                
                order_data = {}
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
                order_match = re.search(r'–Ω–æ–º–µ—Ä\s+(\d+)', instructions_text)
                if order_match:
                    order_data['order'] = int(order_match.group(1))
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É
                date_match = re.search(r'(\d{1,2})\s+—Å–µ–Ω—Ç—è–±—Ä—è', instructions_text)
                if date_match:
                    day = int(date_match.group(1))
                    order_data['date'] = f"2025-09-{day:02d}"
                
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–≤–∞—Ä (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
                    product_match = re.search(r'(alseit_\d+|–±–∞—É—Å–∏—Ç\s+\d+|balseit\s*_\d+)', instructions_text.lower())
                if product_match:
                        product = product_match.group(1)
                        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
                        if '–±–∞—É—Å–∏—Ç' in product:
                            product = product.replace('–±–∞—É—Å–∏—Ç', 'balseit')
                        # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤–æ–∫—Ä—É–≥ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
                        product = product.replace(' ', '')
                        order_data['product'] = product
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                manager_match = re.search(r'–º–µ–Ω–µ–¥–∂–µ—Ä\s+(\w+)', instructions_text.lower())
                if manager_match:
                    order_data['manager'] = manager_match.group(1)
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                quantity_match = re.search(r'(\d+)\s+—à—Ç—É–∫', instructions_text.lower())
                if quantity_match:
                    order_data['quantity'] = int(quantity_match.group(1))
                else:
                    order_data['quantity'] = 1  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 —à—Ç—É–∫–∞
                    
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–æ—Å—Ç–∞–≤–∫—É
                delivery_match = re.search(r'–¥–æ—Å—Ç–∞–≤–∫–∞\s+–≤\s+(\w+)', instructions_text.lower())
                if delivery_match:
                    order_data['delivery'] = delivery_match.group(1)
                else:
                    # –ü—Ä–æ–±—É–µ–º –±–µ–∑ "–≤"
                    delivery_match = re.search(r'–¥–æ—Å—Ç–∞–≤–∫–∞\s+(\w+)', instructions_text.lower())
                    if delivery_match:
                        order_data['delivery'] = delivery_match.group(1)
                
                if order_data:
                    instructions.append({
                        'action': 'create_new_order',
                        'data': order_data
                    })
            else:
                # –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–∏–ø–∞ "order == 1" –∏ "manager = –ê–π–¥–∞–Ω–∞"
                import re
                order_match = re.search(r'order\s*==\s*(\d+)', instructions_text)
                field_match = re.search(r'(\w+)\s*=\s*([^,\n]+)', instructions_text)
            
            if order_match and field_match:
                order_num = int(order_match.group(1))
                field = field_match.group(1).strip()
                new_value = field_match.group(2).strip()
                
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                if new_value.isdigit():
                    new_value = int(new_value)
                elif new_value.replace('.', '').isdigit():
                    new_value = float(new_value)
                elif new_value.startswith('"') and new_value.endswith('"'):
                    new_value = new_value[1:-1]
                elif new_value.startswith("'") and new_value.endswith("'"):
                    new_value = new_value[1:-1]
                
                instructions.append({
                    'action': 'find_and_edit',
                    'condition': f'order == {order_num}',
                    'field': field,
                    'new_value': new_value
                })
        
        return instructions
    
    def _apply_condition(self, df: pd.DataFrame, condition: Dict[str, Any]) -> pd.Series:
        """
        –ü—Ä–∏–º–µ–Ω—è–µ—Ç —É—Å–ª–æ–≤–∏–µ –ø–æ–∏—Å–∫–∞ –∫ DataFrame
        
        Args:
            df: DataFrame –¥–ª—è –ø–æ–∏—Å–∫–∞
            condition: –°–ª–æ–≤–∞—Ä—å —Å —É—Å–ª–æ–≤–∏–µ–º –ø–æ–∏—Å–∫–∞
            
        Returns:
            pandas.Series: –ú–∞—Å–∫–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫
        """
        try:
            # –ù–∞—á–∏–Ω–∞–µ–º —Å True –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
            mask = pd.Series([True] * len(df), index=df.index)
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞–∂–¥–æ–µ —É—Å–ª–æ–≤–∏–µ
            for field, value in condition.items():
                if field in df.columns:
                    if isinstance(value, str):
                        # –î–ª—è —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ
                        if value.startswith('*') and value.endswith('*'):
                            # –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                            search_value = value[1:-1]
                            mask &= df[field].astype(str).str.contains(search_value, case=False, na=False)
                        else:
                            # –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                            mask &= df[field].astype(str).str.lower() == value.lower()
                    else:
                        # –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                        mask &= df[field] == value
                else:
                    print(f"‚ö†Ô∏è –ü–æ–ª–µ '{field}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ DataFrame")
            
            return mask
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —É—Å–ª–æ–≤–∏—è: {e}")
            return pd.Series([False] * len(df), index=df.index)
    
    def _save_excel_changes(self, excel_file_path: str, modified_df: pd.DataFrame) -> None:
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Excel —Ñ–∞–π–ª"""
        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
            wb = load_workbook(excel_file_path)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏—Å—Ç '–ø—Ä–æ–¥–∞–∂–∏'
            if '–ø—Ä–æ–¥–∞–∂–∏' in wb.sheetnames:
                ws = wb['–ø—Ä–æ–¥–∞–∂–∏']
            else:
                ws = wb.active
            
            # –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            ws.delete_rows(1, ws.max_row)
            
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            for col, header in enumerate(modified_df.columns, 1):
                ws.cell(row=1, column=col, value=header)
            
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            for row_idx, row_data in enumerate(modified_df.itertuples(index=False), 2):
                for col_idx, value in enumerate(row_data, 1):
                    ws.cell(row=row_idx, column=col_idx, value=value)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
            wb.save(excel_file_path)
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: {e}")
            raise
